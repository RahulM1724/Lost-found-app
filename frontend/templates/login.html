{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
    .admin-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: var(--bg-secondary);
        border-radius: 15px;
        padding: 1.8rem;
        box-shadow: var(--card-shadow);
        display: flex;
        align-items: center;
        gap: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-shadow-hover);
    }
    
    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
    }
    
    .stat-icon.blue { background: rgba(33, 150, 243, 0.1); color: #2196f3; }
    .stat-icon.red { background: rgba(244, 67, 54, 0.1); color: #f44336; }
    .stat-icon.green { background: rgba(76, 175, 80, 0.1); color: #4caf50; }
    .stat-icon.purple { background: rgba(156, 39, 176, 0.1); color: #9c27b0; }
    
    .stat-info h3 {
        font-size: 2rem;
        margin-bottom: 0.2rem;
    }
    
    .stat-info p {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .admin-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    @media (max-width: 768px) {
        .admin-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .admin-card {
        background: var(--bg-secondary);
        border-radius: 15px;
        padding: 1.8rem;
        box-shadow: var(--card-shadow);
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .card-header h2 {
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th {
        text-align: left;
        padding: 1rem 0.5rem;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.85rem;
        text-transform: uppercase;
    }
    
    td {
        padding: 1rem 0.5rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .status-badge {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        display: inline-block;
    }
    
    .status-pending { background: rgba(255, 152, 0, 0.1); color: #ff9800; }
    .status-matched { background: rgba(76, 175, 80, 0.1); color: #4caf50; }
    .status-resolved { background: rgba(33, 150, 243, 0.1); color: #2196f3; }
    
    .action-btn {
        padding: 0.4rem 0.8rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8rem;
        margin: 0 0.2rem;
        transition: all 0.3s ease;
    }
    
    .action-btn.view { background: #2196f3; color: white; }
    .action-btn.resolve { background: #4caf50; color: white; }
    
    .action-btn:hover {
        transform: translateY(-2px);
        opacity: 0.9;
    }
    
    .vehicle-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .vehicle-mini-card {
        background: var(--bg-primary);
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        border: 1px solid var(--border-color);
    }
    
    .vehicle-mini-card i {
        font-size: 1.5rem;
        color: var(--primary);
        margin-bottom: 0.5rem;
    }
    
    .vehicle-mini-card h4 {
        font-size: 0.9rem;
        margin-bottom: 0.3rem;
    }
    
    .vehicle-mini-card p {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    
    .warning-note {
        background: rgba(255, 152, 0, 0.1);
        color: #ff9800;
        padding: 0.5rem;
        border-radius: 5px;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container fade-in">
    <div class="warning-note">
        <i class="fas fa-exclamation-triangle"></i>
        Admin Panel - No login required for demo
    </div>
    
    <h1 style="margin-bottom: 2rem;">
        <i class="fas fa-user-shield" style="color: var(--primary);"></i>
        Admin Dashboard
    </h1>
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <div class="stat-info">
                <h3 id="totalReports">0</h3>
                <p>Total Reports</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon red">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-info">
                <h3 id="lostCount">0</h3>
                <p>Lost Items</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon green">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <h3 id="foundCount">0</h3>
                <p>Found Items</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon purple">
                <i class="fas fa-handshake"></i>
            </div>
            <div class="stat-info">
                <h3 id="matchedCount">0</h3>
                <p>Matched</p>
            </div>
        </div>
    </div>
    
    <!-- Main Grid -->
    <div class="admin-grid">
        <!-- Recent Reports Table -->
        <div class="admin-card">
            <div class="card-header">
                <h2><i class="fas fa-history"></i> All Reports</h2>
                <button onclick="loadReports()" class="btn btn-primary btn-sm">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Item</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Vehicle</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        <tr><td colspan="7" class="loading">Loading reports...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Vehicles List -->
        <div class="admin-card">
            <div class="card-header">
                <h2><i class="fas fa-bus"></i> Active Vehicles</h2>
            </div>
            
            <div class="vehicle-grid" id="vehicleGrid">
                <!-- Will be loaded via API -->
            </div>
        </div>
    </div>
    
    <!-- Blockchain Status -->
    <div class="admin-card">
        <div class="card-header">
            <h2><i class="fas fa-link"></i> Blockchain Status</h2>
        </div>
        <div id="blockchainStatus" style="padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
            <div class="loading">Loading blockchain data...</div>
        </div>
    </div>
</div>

<script>
    const API_URL = 'http://127.0.0.1:5000/api';
    
    // Load all reports
    async function loadReports() {
        try {
            const response = await fetch(`${API_URL}/reports`);
            const reports = await response.json();
            
            // Update stats
            document.getElementById('totalReports').textContent = reports.length;
            
            const lostCount = reports.filter(r => r.type === 'lost').length;
            const foundCount = reports.filter(r => r.type === 'found').length;
            const matchedCount = reports.filter(r => r.status === 'matched').length;
            
            document.getElementById('lostCount').textContent = lostCount;
            document.getElementById('foundCount').textContent = foundCount;
            document.getElementById('matchedCount').textContent = matchedCount;
            
            // Update table
            const tbody = document.getElementById('reportsTableBody');
            
            if (reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No reports found</td></tr>';
                return;
            }
            
            let html = '';
            reports.forEach(report => {
                html += `
                    <tr>
                        <td>#${report.id}</td>
                        <td>
                            <strong>${report.item_name}</strong><br>
                            <small>${(report.description || '').substring(0, 30)}...</small>
                        </td>
                        <td>
                            <span class="badge badge-${report.type === 'lost' ? 'danger' : 'success'}">
                                ${report.type.toUpperCase()}
                            </span>
                        </td>
                        <td>${report.location || 'N/A'}</td>
                        <td>${report.vehicle_id || 'N/A'}</td>
                        <td>
                            <span class="status-badge status-${report.status}">
                                ${report.status}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn view" onclick="viewReport(${report.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn resolve" onclick="updateStatus(${report.id}, 'resolved')">
                                <i class="fas fa-check"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        } catch (error) {
            console.error('Error loading reports:', error);
            document.getElementById('reportsTableBody').innerHTML = 
                '<tr><td colspan="7" class="loading" style="color: var(--danger);">Error loading reports</td></tr>';
        }
    }
    
    // Load vehicles
    async function loadVehicles() {
        const vehicles = ['BUS001', 'BUS002', 'TRAIN001', 'METRO001'];
        const grid = document.getElementById('vehicleGrid');
        
        let html = '';
        
        for (const vehicleId of vehicles) {
            try {
                const response = await fetch(`${API_URL}/vehicle/${vehicleId}/qr`);
                const vehicle = await response.json();
                
                const icon = vehicle.type === 'bus' ? 'fa-bus' :
                            vehicle.type === 'train' ? 'fa-train' : 'fa-subway';
                
                html += `
                    <div class="vehicle-mini-card">
                        <i class="fas ${icon}"></i>
                        <h4>${vehicle.vehicle_id}</h4>
                        <p>${vehicle.type} • ${vehicle.route}</p>
                    </div>
                `;
            } catch (error) {
                console.error(`Error loading ${vehicleId}:`, error);
            }
        }
        
        grid.innerHTML = html || '<p>No vehicles found</p>';
    }
    
    // Load blockchain status
    async function loadBlockchainStatus() {
        try {
            const response = await fetch(`${API_URL}/blockchain/chain`);
            const data = await response.json();
            
            const container = document.getElementById('blockchainStatus');
            
            let blocksHtml = '';
            data.chain.slice(-3).reverse().forEach(block => {
                blocksHtml += `
                    <div style="background: var(--bg-secondary); padding: 0.8rem; margin: 0.5rem 0; border-radius: 5px; border-left: 3px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between;">
                            <span><strong>Block #${block.index}</strong></span>
                            <span style="color: var(--text-secondary); font-size: 0.8rem;">${(block.timestamp || '').substring(0, 19)}</span>
                        </div>
                        <div style="font-family: monospace; font-size: 0.8rem; color: var(--text-secondary);">
                            Hash: ${(block.hash || '').substring(0, 30)}...
                        </div>
                        ${block.data?.item_name ? `
                            <div style="margin-top: 0.3rem; font-size: 0.8rem;">
                                <i class="fas fa-cube"></i> ${block.data.item_name}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <strong>Chain Length:</strong> ${data.length} | 
                    <strong>Valid:</strong> <span style="color: ${data.valid ? '#4caf50' : '#f44336'}">${data.valid ? '✓' : '✗'}</span>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${blocksHtml}
                </div>
            `;
        } catch (error) {
            console.error('Error loading blockchain:', error);
            document.getElementById('blockchainStatus').innerHTML = 
                '<div style="color: var(--danger);">Error loading blockchain</div>';
        }
    }
    
    // View report
    function viewReport(id) {
        window.open(`/api/report/${id}`, '_blank');
    }
    
    // Update report status
    async function updateStatus(id, status) {
        try {
            const response = await fetch(`${API_URL}/admin/report/${id}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });
            
            const result = await response.json();
            if (result.success) {
                showNotification('✅ Status updated', 'success');
                loadReports();
            } else {
                showNotification('❌ Update failed', 'error');
            }
        } catch (error) {
            showNotification('Error updating status', 'error');
        }
    }
    
    // Load all data on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadReports();
        loadVehicles();
        loadBlockchainStatus();
    });
</script>
{% endblock %}